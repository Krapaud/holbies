#!/usr/bin/env python3
"""
Menu interactif pour la gestion des utilisateurs et de l'administration
"""

import sys
import os
from datetime import datetime

# Ajouter le r√©pertoire src au PATH
sys.path.insert(0, '/app/src')

from sqlalchemy.orm import Session
from sqlalchemy import text
from app.database import SessionLocal
from app.models import User
from passlib.context import CryptContext

# Configuration du hashage des mots de passe
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def hash_password(password: str) -> str:
    """Hash un mot de passe"""
    return pwd_context.hash(password)

def clear_screen():
    """Efface l'√©cran"""
    print("\n" * 50)

def show_header():
    """Affiche l'en-t√™te du menu"""
    print("üéØ" + "=" * 60 + "üéØ")
    print("üöÄ           MENU ADMINISTRATEUR HOLBIES           üöÄ")
    print("üéØ" + "=" * 60 + "üéØ")
    print()

def list_all_users():
    """Liste tous les utilisateurs"""
    db = SessionLocal()
    try:
        users = db.query(User).order_by(User.id).all()
        
        print("üë• LISTE DES UTILISATEURS")
        print("=" * 50)
        
        if not users:
            print("üì≠ Aucun utilisateur trouv√©")
            return
        
        print(f"üìä Total: {len(users)} utilisateur(s)\n")
        
        for user in users:
            admin_badge = "üëë ADMIN" if getattr(user, 'is_admin', False) else "üë§ USER"
            status = "‚úÖ" if user.is_active else "‚ùå"
            created = user.created_at.strftime("%d/%m/%Y") if user.created_at else "N/A"
            
            print(f"{admin_badge} | {status} | ID:{user.id:2d} | {user.username:15s} | {user.email:25s} | {created}")
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
    finally:
        db.close()

def create_user():
    """Cr√©e un nouvel utilisateur"""
    db = SessionLocal()
    try:
        print("‚ú® CR√âATION D'UN NOUVEL UTILISATEUR")
        print("-" * 40)
        
        username = input("üë§ Nom d'utilisateur: ").strip()
        if not username:
            print("‚ùå Le nom d'utilisateur ne peut pas √™tre vide")
            return
        
        email = input("üìß Email: ").strip()
        if not email:
            print("‚ùå L'email ne peut pas √™tre vide")
            return
        
        password = input("üîê Mot de passe: ").strip()
        if not password:
            print("‚ùå Le mot de passe ne peut pas √™tre vide")
            return
        
        is_admin_input = input("üëë Administrateur ? (o/N): ").strip().lower()
        is_admin = is_admin_input in ['o', 'oui', 'y', 'yes']
        
        # V√©rifier si l'utilisateur existe d√©j√†
        existing_user = db.query(User).filter(
            (User.username == username) | (User.email == email)
        ).first()
        
        if existing_user:
            print("‚ùå Un utilisateur avec ce nom ou cet email existe d√©j√†")
            return
        
        # Cr√©er l'utilisateur
        hashed_pwd = hash_password(password)
        new_user = User(
            username=username,
            email=email,
            hashed_password=hashed_pwd,
            is_active=True
        )
        
        # Ajouter le champ is_admin si la migration a √©t√© faite
        try:
            setattr(new_user, 'is_admin', is_admin)
        except:
            pass
        
        db.add(new_user)
        db.commit()
        db.refresh(new_user)
        
        role = "üëë Administrateur" if is_admin else "üë§ Utilisateur"
        print(f"‚úÖ Utilisateur cr√©√© avec succ√®s!")
        print(f"   ID: {new_user.id}")
        print(f"   Nom: {username}")
        print(f"   Email: {email}")
        print(f"   R√¥le: {role}")
        
    except Exception as e:
        print(f"‚ùå Erreur lors de la cr√©ation: {e}")
        db.rollback()
    finally:
        db.close()

def delete_user():
    """Supprime un utilisateur"""
    db = SessionLocal()
    try:
        list_all_users()
        print("\nüóëÔ∏è  SUPPRESSION D'UTILISATEUR")
        print("-" * 30)
        
        user_id = input("ID de l'utilisateur √† supprimer: ").strip()
        if not user_id.isdigit():
            print("‚ùå ID invalide")
            return
        
        user = db.query(User).filter(User.id == int(user_id)).first()
        if not user:
            print("‚ùå Utilisateur introuvable")
            return
        
        print(f"‚ö†Ô∏è  Vous allez supprimer: {user.username} ({user.email})")
        confirm = input("Confirmer la suppression (tapez 'SUPPRIMER'): ").strip()
        
        if confirm != "SUPPRIMER":
            print("‚ùå Suppression annul√©e")
            return
        
        db.delete(user)
        db.commit()
        print("‚úÖ Utilisateur supprim√© avec succ√®s")
        
    except Exception as e:
        print(f"‚ùå Erreur lors de la suppression: {e}")
        db.rollback()
    finally:
        db.close()

def toggle_admin_status():
    """Active/D√©sactive le statut admin d'un utilisateur"""
    db = SessionLocal()
    try:
        # D'abord, essayons d'ajouter la colonne is_admin si elle n'existe pas
        try:
            db.execute(text("ALTER TABLE users ADD COLUMN is_admin BOOLEAN DEFAULT FALSE"))
            db.commit()
            print("‚úÖ Colonne is_admin ajout√©e")
        except:
            # La colonne existe d√©j√†
            pass
        
        list_all_users()
        print("\nüëë GESTION DES DROITS ADMINISTRATEUR")
        print("-" * 40)
        
        user_id = input("ID de l'utilisateur: ").strip()
        if not user_id.isdigit():
            print("‚ùå ID invalide")
            return
        
        user = db.query(User).filter(User.id == int(user_id)).first()
        if not user:
            print("‚ùå Utilisateur introuvable")
            return
        
        # Utiliser une requ√™te SQL directe pour mettre √† jour is_admin
        current_admin = False
        try:
            result = db.execute(text("SELECT is_admin FROM users WHERE id = :id"), {"id": user.id}).fetchone()
            current_admin = result[0] if result else False
        except:
            pass
        
        new_status = not current_admin
        status_text = "üëë Administrateur" if new_status else "üë§ Utilisateur standard"
        
        print(f"üë§ Utilisateur: {user.username}")
        print(f"üìã Statut actuel: {'üëë Admin' if current_admin else 'üë§ User'}")
        print(f"üìã Nouveau statut: {status_text}")
        
        confirm = input("Confirmer le changement (o/N): ").strip().lower()
        if confirm not in ['o', 'oui', 'y', 'yes']:
            print("‚ùå Changement annul√©")
            return
        
        # Mettre √† jour via SQL direct
        db.execute(text("UPDATE users SET is_admin = :is_admin WHERE id = :id"), 
                  {"is_admin": new_status, "id": user.id})
        db.commit()
        
        print(f"‚úÖ Statut mis √† jour: {user.username} est maintenant {status_text}")
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        db.rollback()
        import traceback
        traceback.print_exc()
    finally:
        db.close()

def clear_all_users():
    """Vide tous les utilisateurs"""
    db = SessionLocal()
    try:
        user_count = db.query(User).count()
        
        if user_count == 0:
            print("üì≠ Aucun utilisateur √† supprimer")
            return
        
        print(f"‚ö†Ô∏è  ATTENTION: Suppression de {user_count} utilisateur(s)")
        print("üö® Cette action est IRR√âVERSIBLE!")
        confirm = input("Tapez 'VIDER TOUT' pour confirmer: ").strip()
        
        if confirm != "VIDER TOUT":
            print("‚ùå Suppression annul√©e")
            return
        
        deleted = db.query(User).delete()
        db.commit()
        print(f"‚úÖ {deleted} utilisateur(s) supprim√©(s)")
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        db.rollback()
    finally:
        db.close()

def create_test_data():
    """Cr√©e des donn√©es de test"""
    db = SessionLocal()
    try:
        print("üß™ CR√âATION DE DONN√âES DE TEST")
        print("-" * 30)
        
        # V√©rifier s'il y a d√©j√† des utilisateurs
        existing_count = db.query(User).count()
        if existing_count > 0:
            print(f"‚ö†Ô∏è  Il y a d√©j√† {existing_count} utilisateur(s)")
            confirm = input("Continuer quand m√™me ? (o/N): ").strip().lower()
            if confirm not in ['o', 'oui', 'y', 'yes']:
                print("‚ùå Annul√©")
                return
        
        # Donn√©es de test
        test_users = [
            ("admin", "admin@holbies.dev", "admin123", True),
            ("student1", "student1@holbies.dev", "student123", False),
            ("student2", "student2@holbies.dev", "student123", False),
            ("teacher", "teacher@holbies.dev", "teacher123", True),
            ("demo_user", "demo@holbies.dev", "demo123", False),
        ]
        
        created_count = 0
        for username, email, password, is_admin in test_users:
            # V√©rifier si l'utilisateur existe d√©j√†
            existing = db.query(User).filter(
                (User.username == username) | (User.email == email)
            ).first()
            
            if existing:
                print(f"‚è≠Ô∏è  {username} existe d√©j√†, ignor√©")
                continue
            
            # Cr√©er l'utilisateur
            hashed_pwd = hash_password(password)
            new_user = User(
                username=username,
                email=email,
                hashed_password=hashed_pwd,
                is_active=True
            )
            
            db.add(new_user)
            db.flush()  # Pour obtenir l'ID
            
            # Ajouter le statut admin via SQL direct
            try:
                db.execute(text("UPDATE users SET is_admin = :is_admin WHERE id = :id"), 
                          {"is_admin": is_admin, "id": new_user.id})
            except:
                pass
            
            created_count += 1
            role = "üëë Admin" if is_admin else "üë§ User"
            print(f"‚úÖ {username} ({role})")
        
        db.commit()
        print(f"\nüéØ {created_count} utilisateur(s) de test cr√©√©(s)")
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        db.rollback()
        import traceback
        traceback.print_exc()
    finally:
        db.close()

def show_database_stats():
    """Affiche les statistiques de la base de donn√©es"""
    db = SessionLocal()
    try:
        print("üìä STATISTIQUES DE LA BASE DE DONN√âES")
        print("=" * 40)
        
        # Statistiques des utilisateurs
        total_users = db.query(User).count()
        active_users = db.query(User).filter(User.is_active == True).count()
        
        # Compter les admins (avec gestion d'erreur)
        admin_count = 0
        try:
            result = db.execute(text("SELECT COUNT(*) FROM users WHERE is_admin = true")).fetchone()
            admin_count = result[0] if result else 0
        except:
            pass
        
        print(f"üë• Utilisateurs totaux: {total_users}")
        print(f"‚úÖ Utilisateurs actifs: {active_users}")
        print(f"‚ùå Utilisateurs inactifs: {total_users - active_users}")
        print(f"üëë Administrateurs: {admin_count}")
        print(f"üë§ Utilisateurs standard: {total_users - admin_count}")
        
        # Autres statistiques si les tables existent
        try:
            quiz_sessions = db.execute(text("SELECT COUNT(*) FROM quiz_sessions")).fetchone()[0]
            questions = db.execute(text("SELECT COUNT(*) FROM questions")).fetchone()[0]
            print(f"üéØ Sessions de quiz: {quiz_sessions}")
            print(f"‚ùì Questions: {questions}")
        except:
            print("üéØ Sessions de quiz: Table non trouv√©e")
            print("‚ùì Questions: Table non trouv√©e")
        
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
    finally:
        db.close()

def main_menu():
    """Menu principal"""
    while True:
        clear_screen()
        show_header()
        show_database_stats()
        
        print("\nüéÆ MENU PRINCIPAL")
        print("=" * 20)
        print("1Ô∏è‚É£  üìã Lister les utilisateurs")
        print("2Ô∏è‚É£  ‚ú® Cr√©er un utilisateur")
        print("3Ô∏è‚É£  üóëÔ∏è  Supprimer un utilisateur")
        print("4Ô∏è‚É£  üëë G√©rer les droits admin")
        print("5Ô∏è‚É£  üß™ Cr√©er des donn√©es de test")
        print("6Ô∏è‚É£  üóëÔ∏è  Vider tous les utilisateurs")
        print("7Ô∏è‚É£  üìä Actualiser les statistiques")
        print("0Ô∏è‚É£  üö™ Quitter")
        print()
        
        choice = input("üéØ Votre choix: ").strip()
        
        print("\n" + "="*60)
        
        if choice == "1":
            list_all_users()
        elif choice == "2":
            create_user()
        elif choice == "3":
            delete_user()
        elif choice == "4":
            toggle_admin_status()
        elif choice == "5":
            create_test_data()
        elif choice == "6":
            clear_all_users()
        elif choice == "7":
            continue  # Rafra√Æchit l'affichage
        elif choice == "0":
            print("üëã Au revoir!")
            break
        else:
            print("‚ùå Choix invalide")
        
        if choice != "0" and choice != "7":
            input("\n‚èé Appuyez sur Entr√©e pour continuer...")

if __name__ == "__main__":
    try:
        main_menu()
    except KeyboardInterrupt:
        print("\n\nüëã Au revoir!")
    except Exception as e:
        print(f"\n‚ùå Erreur fatale: {e}")
        import traceback
        traceback.print_exc()
